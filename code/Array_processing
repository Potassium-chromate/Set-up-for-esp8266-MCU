#include <ESP8266WiFi.h>
#include <WiFiClient.h>
#include <ESP8266WebServer.h>
#include <ArduinoJson.h>


const char *ssid = "your_SSID";
const char *password = "your_PASSWORD";
const int serverPort = 80;

ESP8266WebServer server(serverPort);

void setup() {
  Serial.begin(115200);
  
  WiFi.mode(WIFI_AP);
  WiFi.softAP(ssid, password);

  IPAddress IP = WiFi.softAPIP();
  Serial.print("AP IP address: ");
  Serial.println(IP);

  server.on("/sendArray", HTTP_POST, handleArray);
  server.begin();
  Serial.println("HTTP server started");
}

void loop() {
  server.handleClient();
}

void handleArray() {
   if (server.hasArg("plain")) {
    int fpgaFlag = Serial1.read();
    if (fpgaFlag == 1) {
      server.send(503, "text/plain", "FPGA is busy");
    } else if (fpgaFlag == 0) {
      String receivedArray = server.arg("plain");
      Serial.println("Received array: " + receivedArray);

      // Parse the received array
      DynamicJsonDocument doc(1024);
      deserializeJson(doc, receivedArray);
      JsonArray array = doc.as<JsonArray>();

      // Send the array elements as 8-bit integers
      for (int value : array) {
        Serial1.write(value & 0xFF);
      }

      // Send a success response
      server.send(200, "text/plain", "Array received and processed");
    } else {
      // If the received flag value is unexpected or invalid
      server.send(400, "text/plain", "Invalid FPGA flag value");
    }
  } else {
    server.send(400, "text/plain", "Missing array data");
  }
}
